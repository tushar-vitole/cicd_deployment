name: Build, Version, and Push to ECR (Dynamic Environment + OIDC)

on:
  push:
    branches:
      - dev
      - prod

permissions:
  id-token: write
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Bump version in package.json
        id: version_bump
        run: |
          current_version=$(node -p "require('./package.json').version")
          IFS='.' read -r major minor patch <<< "$current_version"
          patch=$((patch + 1))
          new_version="$major.$minor.$patch"
          npm version "$new_version" --no-git-tag-version
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------------------------------------
      # STEP 1: CHECK / CREATE VPC
      # ---------------------------------------------------------
      - name: Check and create VPC if missing
        id: vpc_check
        run: |
          echo "ðŸ” Checking for VPC named 'CC-DEMO-VPC'..."

          vpc_id=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=CC-DEMO-VPC" \
            --query "Vpcs[0].VpcId" \
            --output text)

          if [[ "$vpc_id" == "None" ]]; then
            echo "âš ï¸ VPC not found. Creating VPC from CloudFormation template..."
            
            stack_name="CC-DEMO-VPC-Stack"

            aws cloudformation deploy \
              --stack-name $stack_name \
              --template-file cloud/aws/vpc/vpc.yaml \
              --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND

            aws cloudformation wait stack-create-complete --stack-name $stack_name

            vpc_id=$(aws ec2 describe-vpcs \
              --filters "Name=tag:Name,Values=CC-DEMO-VPC" \
              --query "Vpcs[0].VpcId" --output text)

            echo "âœ… VPC created: $vpc_id"
          else
            echo "âœ… VPC already exists: $vpc_id"
          fi

          echo "vpc_id=$vpc_id" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # STEP 2: CHECK IF ECS CLUSTER EXISTS â€” IF NOT CREATE IT
      # ---------------------------------------------------------
      - name: Check and create ECS Cluster if missing
        id: ecs_check
        run: |
          echo "ðŸ” Checking for ECS Cluster 'CC-DEMO-API-CLUSTER'..."

          cluster_exists=$(aws ecs describe-clusters \
            --clusters CC-DEMO-API-CLUSTER \
            --query 'clusters[0].status' \
            --output text 2>/dev/null || true)

          if [[ "$cluster_exists" == "ACTIVE" ]]; then
            echo "âœ… ECS Cluster already exists."
            echo "cluster_created=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ECS Cluster not found. Creating using CloudFormation..."

            aws cloudformation deploy \
              --stack-name CC-DEMO-API-CLUSTER-STACK \
              --template-file cloud/aws/ecs+lb/create.yaml \
              --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND

            aws cloudformation wait stack-create-complete \
              --stack-name CC-DEMO-API-CLUSTER-STACK

            echo "âœ… ECS Cluster created successfully."
            echo "cluster_created=true" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # STEP 3: BUILD + PUSH DOCKER IMAGE
      # (Runs ALWAYS â€” cluster creation does not block build)
      # ---------------------------------------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ steps.version_bump.outputs.new_version }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Commit updated package.json
        run: |
          new_version=${{ steps.version_bump.outputs.new_version }}
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json || true
          git commit -m "chore: bump version to $new_version [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.ref_name }} || echo "No changes pushed"