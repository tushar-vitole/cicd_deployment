name: Create IAM User (ReadOnly)

on:
  push:
    branches:
      - user
  workflow_dispatch:
    inputs:
      username:
        description: "IAM username to create"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  create-iam-user:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT-ID>:role/<YOUR-GITHUB-OIDC-ROLE>
          aws-region: ap-south-1

      - name: Get AWS Account ID
        id: acct
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: Create IAM User
        run: |
          aws iam create-user --user-name "${{ github.event.inputs.username }}" \
          || echo "User already exists"

      - name: Attach ReadOnlyAccess Policy
        run: |
          aws iam attach-user-policy \
            --user-name "${{ github.event.inputs.username }}" \
            --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess

      - name: Create Login Password
        run: |
          PASSWORD=$(openssl rand -base64 14)
          aws iam create-login-profile \
            --user-name "${{ github.event.inputs.username }}" \
            --password "$PASSWORD" \
            --password-reset-required || echo "Login profile already exists"
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Output Credentials
        run: |
          echo "============================================="
          echo " IAM USER CREATED SUCCESSFULLY "
          echo "============================================="
          echo "AWS Account ID: $ACCOUNT_ID"
          echo "IAM Username : ${{ github.event.inputs.username }}"
          echo "Password     : $PASSWORD"
          echo "Login URL    : https://$ACCOUNT_ID.signin.aws.amazon.com/console"
          echo "============================================="
